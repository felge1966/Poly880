; POLY-COMPUTER	880
;
; 10.3.1. 10.3.2. Der POLY-COMPUTER macht Musik
; Arbeitshandbuch, S. 223-241
;
; assemblieren mit Arnold-Assembler www.alfsembler.de
; vp120210
;
	cpu	z80

;*************************************************************************
;
; MUSIKPROGRAMM
;
;*************************************************************************
	ORG 	4000H
	LD 	A,25H 		; CTC-KANAL 1 ALS TIMER PROGRAMMIEREN
	OUT 	(CTC1),A 	; ZUR BESTIMMUNG DER TONDAUER
	LD 	A,40H 		; ZEITKONSTANTE FUER 1/128 SEKUNDE
	OUT 	(CTC1),A
	LD 	HL,4100H 	; ZEIGER ZUM LESEN DER "NOTEN"
MUS1 	LD 	A,(HL) 		; TONDAUER LADEN
	INC 	HL
	CP 	00H 		; ENDE DER MELODIE?
	JR	Z,ENDE 		; FERTIG!
	LD 	C,A 		; DAUER DES TONES IN C
MUS2 	LD 	A,(HL) 		; KODE FUER DIE TONHOEHE
	CP 	0FFH 		; PAUSE?
	JR	Z,MUS3 		; PAUSE!
	PUSH 	HL
	LD 	H,40H
	ADD 	A,80H 		; ZEIGER FUER TONHOEHENTABELLE
	LD 	L,A
	LD 	B,(HL) 		; ZEITKONSTANTE N13
	DJNZ 	$ 		; ZEITSCHLEIFE Z13
	INC 	HL
	LD 	B,(HL) 		; ZEITKONSTANTE N17
MUSZ 	NOP
	DJNZ 	MUSZ
	POP 	HL 		; ZEIGER FUER "NOTEN"
	IN 	A,(PIOD2) 	; MAGNETBANDANSCHLUSS
	XOR 	04H 		; T/2 VERGANGEN
	OUT 	(PIOD2),A
MUS3 	IN 	A,(CTC1) 	; TONDAUER
	XOR 	D 		; VERGLEICH MIT LETZTEN WERT
	BIT 	5,A 		; AENDERUNG7
	JR	NZ,MUS4 	; JA!
	LD 	B,N1 		; LAUFZEITKOMPENSATION
	DJNZ 	$
	JR 	MUS2 		; NAECHSTES T/2
MUS4 	XOR 	D
	LD 	D,A 		; CTC-WERT IN D ABSPEICHERN
	DEC 	C 		; TONDAUERZAEHLER
	JR	Z,MUS5 		; FERTIG MIT DIESER "NOTE"
	LD 	B,N1 		; LAUFZEITKOMPENSATION
	DJNZ 	$
	JR 	MUS2
MUS5 	INC 	HL
	JR 	MUS1
ENDE 	HALT 			; FERTIG MIT INTERPRETATION DER "NOTEN"
CTC1 	EQU 	89H 		; ADRESSE CTC-KANAL 1
PIOD2 	EQU 	82H 		; ADRESSE MAGNETBANDANSCHLUSS
N1 	EQU 	3
N2 	EQU 	5
;
;	TABELLE DER TONHOEHEN
;
	ORG 	4080H
	DB	8CH		;a
	DB	04H
	DB	83H
	DB	04H
	DB	70H
	DB	0CH
	DB	75H
	DB	02H
	DB	5FH
	DB	0DH
	DB	61H
	DB	06H
	DB	56H
	DB	0AH
	DB	4CH
	DB	0CH
	DB	53H
	DB	02H
	DB	4CH
	DB	03H
	DB	44H
	DB	05H
	DB	3BH
	DB	08H
	DB	31H
	DB	0CH
	DB	33H
	DB	07H
	DB	34H
	DB	03H
	DB	2CH
	DB	06H
	DB	22H
	DB	0AH
	DB	25H
	DB	05H
	DB	20H
	DB	07H
	DB	22H
	DB	03H
	DB	1FH
	DB	03H
	DB	13H
	DB	0AH
	DB	0FH
	DB	0BH
	DB	13H
	DB	06H
	DB	0EH
	DB	08H
	DB	11H
	DB	04H
	DB	07H
	DB	0AH
	DB	01H
	DB	0DH
	DB	07H
	DB	07H
	DB	0DH
	DB	01H
	DB	0AH
	DB	02H
	DB	02H
	DB	07H
	DB	03H
	DB	05H
	DB	03H
	DB	04H
	DB	03H
	DB	03H
	DB	03H
	DB	02H
	DB	03H		;a'''
	DB	01H

	org	4100h

;"Popcorn"
	DB	0CH,030H
	DB	0CH,0FFH
	DB	0CH,02CH
	DB	0CH,0FFH
	DB	0CH,030H
	DB	0CH,0FFH
	DB	0CH,026H
	DB	0CH,0FFH
	DB	0CH,01EH
	DB	0CH,0FFH
	DB	0CH,026H
	DB	0CH,0FFH
	DB	0CH,018H
	DB	0CH,0FFH
	DB	18H,0FFH
	
	DB	0CH,030H
	DB	0CH,0FFH
	DB	0CH,02CH
	DB	0CH,0FFH
	DB	0CH,030H
	DB	0CH,0FFH
	DB	0CH,026H
	DB	0CH,0FFH
	DB	0CH,01EH
	DB	0CH,0FFH
	DB	0CH,026H
	DB	0CH,0FFH
	DB	0CH,018H
	DB	0CH,0FFH
	DB	18H,0FFH
	DB	0CH,030H
	DB	0CH,0FFH
	DB	0CH,034H
	DB	0CH,0FFH
	DB	0CH,036H
	DB	0CH,0FFH
	DB	0CH,034H
	DB	0CH,0FFH
	DB	0CH,036H
	DB	0CH,0FFH
	DB	0CH,030H
	DB	0CH,0FFH
	DB	0CH,034H
	DB	0CH,0FFH
	DB	0CH,030H
	DB	0CH,0FFH
	DB	0CH,034H
	DB	0CH,0FFH
	DB	0CH,02CH
	DB	0CH,0FFH
	DB	0CH,030H
	DB	0CH,0FFH
	DB	0CH,02CH
	DB	0CH,0FFH
	DB	0CH,030H
	DB	0CH,0FFH
	DB	0CH,026H
	DB	0CH,0FFH
	DB	0CH,030H
	DB	0CH,0FFH
	DB	18H,0FFH

	DB	0CH,030H
	DB	0CH,0FFH
	DB	0CH,02CH
	DB	0CH,0FFH
	DB	0CH,030H
	DB	0CH,0FFH
	DB	0CH,026H
	DB	0CH,0FFH
	DB	0CH,01EH
	DB	0CH,0FFH
	DB	0CH,026H
	DB	0CH,0FFH
	DB	0CH,018H
	DB	0CH,0FFH
	DB	18H,0FFH
	
	DB	0CH,030H
	DB	0CH,0FFH
	DB	0CH,02CH
	DB	0CH,0FFH
	DB	0CH,030H
	DB	0CH,0FFH
	DB	0CH,026H
	DB	0CH,0FFH
	DB	0CH,01EH
	DB	0CH,0FFH
	DB	0CH,026H
	DB	0CH,0FFH
	DB	0CH,018H
	DB	0CH,0FFH
	DB	18H,0FFH
	DB	0CH,030H
	DB	0CH,0FFH
	DB	0CH,034H
	DB	0CH,0FFH
	DB	0CH,036H
	DB	0CH,0FFH
	DB	0CH,034H
	DB	0CH,0FFH
	DB	0CH,036H
	DB	0CH,0FFH
	DB	0CH,030H
	DB	0CH,0FFH
	DB	0CH,034H
	DB	0CH,0FFH
	DB	0CH,030H
	DB	0CH,0FFH
	DB	0CH,034H
	DB	0CH,0FFH
	DB	0CH,02CH
	DB	0CH,0FFH
	DB	0CH,030H
	DB	0CH,0FFH
	DB	0CH,02CH
	DB	0CH,0FFH
	DB	0CH,030H
	DB	0CH,0FFH
	DB	0CH,026H
	DB	0CH,0FFH
	DB	0CH,030H
	DB	0CH,0FFH
	DB	18H,0FFH

	DB	0CH,030H
	DB	0CH,0FFH
	DB	0CH,02CH
	DB	0CH,0FFH
	DB	0CH,030H
	DB	54H,0FFH
	DB	0CH,018H
	DB	54H,0FFH
	DB	90H,000H
	DB	00H
	END
